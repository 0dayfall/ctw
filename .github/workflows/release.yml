name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g. v0.1.2). Required when running manually."
        required: false

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Run tests
        run: go test ./...

  goreleaser:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Resolve release ref
        id: release_ref
        run: |
          if [ "${GITHUB_REF_TYPE}" = "tag" ]; then
            echo "ref=${GITHUB_REF}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ -n "${{ inputs.tag }}" ]; then
            echo "ref=refs/tags/${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "No tag provided for manual run. Re-run with a tag (e.g. v0.1.2)." >&2
          exit 1
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.release_ref.outputs.ref }}
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Smoke test (optional)
        env:
          BEARER_TOKEN: ${{ secrets.BEARER_TOKEN }}
        run: |
          if [ -n "${BEARER_TOKEN}" ]; then
            ./script/sh/smoke_real_api.sh
          else
            echo "BEARER_TOKEN not set; skipping smoke test."
          fi
      - uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
